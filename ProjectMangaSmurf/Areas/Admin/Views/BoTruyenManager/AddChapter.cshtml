@model ProjectMangaSmurf.Models.Chapter
@using Microsoft.AspNetCore.Mvc.Rendering
@using ProjectMangaSmurf.Repository
@inject IboTruyenRepository boTruyenRepository
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    .preview {
        max-width: 50%;
        max-height:50%;
    }
</style>

<div class="content">
    <div class="page-header">
        <div class="page-title">
            <h3>Upload new chapter No.@ViewBag.Stt</h3>
            <h3>CID: @ViewBag.Id</h3>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <form asp-action="AddChapter" method="post" enctype="multipart/form-data" class="row">
                <div class="col-lg-3 col-sm-6 col-12">
                    <div class="form-group">
                        <label asp-for="IdBo">Comic Name</label>
                        <input asp-for="IdBo" type="text" value="@ViewBag.Id" readonly>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                    <div class="form-group">
                        <label asp-for="SttChap">Chapter No</label>
                        <input asp-for="SttChap" type="text" value="@ViewBag.Stt" readonly>
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                    <div class="form-group">
                        <label asp-for="TenChap">Description of Chapter</label>
                        <input asp-for="TenChap" type="text" placeholder="Ex : Bantumlum ...">
                    </div>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                    <label asp-for="TtPemium">Premium Stats</label>
                    <select asp-for="TtPemium" class="select">
                        <option>true</option>
                        <option>false</option>
                    </select>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                    <label asp-for="Active">Active Stats</label>
                    <select asp-for="Active" class="select">
                        <option>true</option>
                        <option>false</option>
                    </select>
                </div>
                <div class="col-lg-3 col-sm-6 col-12">
                    <div class="form-group">
                        <label asp-for="TkLuotxem">Init Fake-Totals Views</label>
                        <input asp-for="TkLuotxem" type="text" placeholder="Ex : 10000...">
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="form-group">
                        <div class="image-upload  d-flex flex-column justify-content-center align-center">
                            <input type="file" name="images" class="imgInput" data-target="preview1" multiple>
                            <img class="preview" id="preview1" src="#" alt="your image" />
                            <div class="image-uploads">
                                <img src="~/img/icons/upload.svg" alt="img">
                                <h4>Chọn List Ảnh Chappter</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thêm input để nhập số trang cho mỗi ảnh -->
                <div class="col-lg-6">
                    <div class="form-group">
                        <label for="pageNumbers">Số trang tương ứng (phân cách bằng dấu phẩy)</label>
                        <input type="text" id="pageNumbers" name="pageNumbers" class="form-control">
                    </div>
                </div>

                <div asp-validation-summary="ModelOnly" class="col-lg-12 p-4 text-danger" style="font-size:20px; font-weight:600">
                </div>
                <div class="col-lg-12">
                    <button @* href="javascript:void(0);" *@ type="submit" class="btn btn-submit me-2">Submit</button>
                    <button @* href="productlist.html" *@ class="btn btn-cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $(".imgInput").change(function () {
            var targetID = $(this).data('target');
            readURL(this, targetID);
        });

        // Xử lý việc đọc nhiều ảnh và hiển thị preview cho từng ảnh
        function readURL(input, targetID) {
            if (input.files && input.files.length > 0) {
                for (var i = 0; i < input.files.length; i++) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('#' + targetID).append('<img class="preview" src="' + e.target.result + '">');
                    }
                    reader.readAsDataURL(input.files[i]);
                }
            }
        }

        // Submit form
        $('form').submit(function (event) {
            event.preventDefault();
            var form = $(this);
            var formData = new FormData(form[0]); // Use form[0] to get the actual DOM form element
            var pageNumbers = $('#pageNumbers').val().split(',');

            // Append each page number to the FormData object
            for (var i = 0; i < pageNumbers.length; i++) {
                formData.append('pageNumbers[]', pageNumbers[i].trim());
            }

            // Ajax call to submit the form data
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log("Form submitted successfully");
                    alert('Update Successful!');
                    window.location.href = response.redirectUrl; // Use the redirectUrl returned from the controller
                },
                error: function (xhr) {
                    console.error("Error submitting form: ", xhr.status, xhr.responseText);
                    alert('Failed to update. Error: ' + xhr.responseText);
                }
            });
        });
    });

</script>